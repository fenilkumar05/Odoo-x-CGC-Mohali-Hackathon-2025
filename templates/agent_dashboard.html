{% extends "base.html" %}

{% block title %}Agent Dashboard - QuickDesk{% endblock %}

{% block extra_css %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        text-align: center;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
        pointer-events: none;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }
    
    .stat-card.urgent {
        background: linear-gradient(135deg, var(--danger-color), #dc2626);
    }
    
    .stat-card.warning {
        background: linear-gradient(135deg, var(--warning-color), #d97706);
    }
    
    .stat-card.success {
        background: linear-gradient(135deg, var(--accent-color), #059669);
    }
    
    .stat-card.info {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .stat-icon {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 2rem;
        opacity: 0.3;
    }
    
    .ticket-priority-urgent {
        border-left: 4px solid var(--danger-color);
    }
    
    .ticket-priority-high {
        border-left: 4px solid var(--warning-color);
    }
    
    .ticket-priority-medium {
        border-left: 4px solid #3b82f6;
    }
    
    .ticket-priority-low {
        border-left: 4px solid var(--accent-color);
    }
    
    .activity-timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .activity-timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
    }
    
    .activity-item {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .activity-item::before {
        content: '';
        position: absolute;
        left: -1.75rem;
        top: 0.5rem;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--primary-color);
        border: 2px solid white;
        box-shadow: 0 0 0 2px var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="animate__animated animate__fadeInUp">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-users-cog me-2"></i>Agent Dashboard</h2>
            <p class="text-muted mb-0">Manage and resolve support tickets efficiently</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
            <a href="{{ url_for('tickets.create_ticket') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>New Ticket
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-ticket-alt stat-icon"></i>
            <div class="stat-number">{{ stats.total_tickets }}</div>
            <div class="stat-label">Total Tickets</div>
        </div>
        <div class="stat-card warning">
            <i class="fas fa-folder-open stat-icon"></i>
            <div class="stat-number">{{ stats.open_tickets }}</div>
            <div class="stat-label">Open Tickets</div>
        </div>
        <div class="stat-card info">
            <i class="fas fa-user-check stat-icon"></i>
            <div class="stat-number">{{ stats.my_assigned }}</div>
            <div class="stat-label">My Assigned</div>
        </div>
        <div class="stat-card urgent">
            <i class="fas fa-exclamation-triangle stat-icon"></i>
            <div class="stat-number">{{ stats.urgent_tickets }}</div>
            <div class="stat-label">Urgent Tickets</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-user-times stat-icon"></i>
            <div class="stat-number">{{ stats.unassigned }}</div>
            <div class="stat-label">Unassigned</div>
        </div>
        <div class="stat-card success">
            <i class="fas fa-check-circle stat-icon"></i>
            <div class="stat-number">{{ stats.resolved_today }}</div>
            <div class="stat-label">Resolved Today</div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" name="search" value="{{ current_filters.search }}" placeholder="Search tickets...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="all" {% if current_filters.status == 'all' %}selected{% endif %}>All</option>
                        <option value="open" {% if current_filters.status == 'open' %}selected{% endif %}>Open</option>
                        <option value="in_progress" {% if current_filters.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="resolved" {% if current_filters.status == 'resolved' %}selected{% endif %}>Resolved</option>
                        <option value="closed" {% if current_filters.status == 'closed' %}selected{% endif %}>Closed</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Category</label>
                    <select class="form-select" name="category">
                        <option value="all">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if current_filters.category == category.id|string %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Assignment</label>
                    <select class="form-select" name="assigned">
                        <option value="all" {% if current_filters.assigned == 'all' %}selected{% endif %}>All</option>
                        <option value="me" {% if current_filters.assigned == 'me' %}selected{% endif %}>Assigned to Me</option>
                        <option value="unassigned" {% if current_filters.assigned == 'unassigned' %}selected{% endif %}>Unassigned</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Sort By</label>
                    <select class="form-select" name="sort">
                        <option value="recent" {% if current_filters.sort == 'recent' %}selected{% endif %}>Most Recent</option>
                        <option value="oldest" {% if current_filters.sort == 'oldest' %}selected{% endif %}>Oldest</option>
                        <option value="priority" {% if current_filters.sort == 'priority' %}selected{% endif %}>Priority</option>
                    </select>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <!-- Tickets List -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Tickets
                        <span class="badge bg-secondary ms-2">{{ tickets.total }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if tickets.items %}
                    <div class="list-group list-group-flush">
                        {% for ticket in tickets.items %}
                        <div class="list-group-item ticket-priority-{{ ticket.priority }} p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <a href="{{ url_for('tickets.view_ticket', id=ticket.id) }}" class="text-decoration-none">
                                            #{{ ticket.id }} - {{ ticket.subject }}
                                        </a>
                                    </h6>
                                    <p class="mb-2 text-muted">{{ ticket.description[:100] }}{% if ticket.description|length > 100 %}...{% endif %}</p>
                                    <div class="d-flex align-items-center gap-3">
                                        <span class="badge 
                                            {% if ticket.status == 'open' %}bg-primary
                                            {% elif ticket.status == 'in_progress' %}bg-warning
                                            {% elif ticket.status == 'resolved' %}bg-success
                                            {% else %}bg-secondary{% endif %}">
                                            {{ ticket.status.replace('_', ' ').title() }}
                                        </span>
                                        <span class="badge 
                                            {% if ticket.priority == 'urgent' %}bg-danger
                                            {% elif ticket.priority == 'high' %}bg-warning
                                            {% elif ticket.priority == 'medium' %}bg-info
                                            {% else %}bg-success{% endif %}">
                                            {{ ticket.priority.title() }}
                                        </span>
                                        <small class="text-muted">
                                            <i class="fas fa-user me-1"></i>{{ ticket.creator.username }}
                                        </small>
                                        <small class="text-muted">
                                            <i class="fas fa-tag me-1"></i>{{ ticket.category.name }}
                                        </small>
                                        {% if ticket.assignee %}
                                        <small class="text-muted">
                                            <i class="fas fa-user-check me-1"></i>{{ ticket.assignee.username }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted d-block">{{ ticket.updated_at.strftime('%m/%d %H:%M') }}</small>
                                    <div class="vote-buttons mt-2">
                                        <span class="badge bg-secondary">{{ ticket.vote_score }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Pagination -->
                    {% if tickets.pages > 1 %}
                    <nav aria-label="Tickets pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if tickets.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.agent_dashboard', page=tickets.prev_num, **request.args) }}">Previous</a>
                            </li>
                            {% endif %}
                            
                            {% for page_num in tickets.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != tickets.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('main.agent_dashboard', page=page_num, **request.args) }}">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if tickets.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.agent_dashboard', page=tickets.next_num, **request.args) }}">Next</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No tickets found</h5>
                        <p class="text-muted">Try adjusting your filters or check back later.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Recent Activity Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-clock me-2"></i>Recent Activity</h6>
                </div>
                <div class="card-body">
                    {% if recent_activity %}
                    <div class="activity-timeline">
                        {% for activity in recent_activity %}
                        <div class="activity-item">
                            <div class="fw-semibold">{{ activity.description }}</div>
                            <small class="text-muted">
                                by {{ activity.user.username }} • {{ activity.created_at.strftime('%m/%d %H:%M') }}
                            </small>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-history fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No recent activity</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function refreshDashboard() {
        const btn = event.target.closest('button');
        const hideLoading = showLoading(btn);
        
        // Refresh the page
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }
    
    // Auto-refresh every 5 minutes
    setInterval(() => {
        window.location.reload();
    }, 300000);
</script>
{% endblock %}
